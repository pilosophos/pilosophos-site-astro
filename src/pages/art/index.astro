---
import { Image } from "astro:assets";
import DefaultLayout from "../../layouts/DefaultLayout.astro";
import { getCollection, getEntry, render } from 'astro:content';
import ImageDescription from "../../components/ImageDescription.astro";
import ImageViewer from "../../components/ImageViewer.astro";

const art = (await getCollection('art')).toSorted((a, b) => b.data.date?.getTime() - a.data.date?.getTime());
---

<DefaultLayout title="Art">
  <main class="container">
    <div id="gallery" class="grid md:grid-cols-2 lg:grid-cols-3 justify-center gap-3 mx-auto">
      {
        art.map(async (piece, i) =>
          <a href={ '/art/' + piece.id } class="gallery-item mb-[10px] w-[350px] lg:w-[420px]">
            <Image
              src={ piece.data.cover }
              alt={ piece.data.title }
              quality="max"
              width={420}
              class="art-thumbnail"
              data-index={ i }
              data-art-id={ piece.id }
            />
          </a>
        )
      }
    </div>
  </main>
</DefaultLayout>

<ImageViewer showNav class="hidden"/>

<script>
  import Masonry from 'masonry-layout';
  new Masonry('#gallery', {
    itemSelector: '.gallery-item',
    gutter: 10,
    fitWidth: true,
    transitionDuration: '0.2s',
  })
</script>

{
  // generate templates for image descriptions
  art.map(async (piece, i) => {
    const { Content } = await render(piece);

    return (
      <template id={ 'desc-' + piece.id }>
        <ImageDescription
          slot="description"
          title={ piece.data.title }
          date={ piece.data.date }
        >
          <Content />
        </ImageDescription>
      </template>
    )
  })
}

{
  // generate templates for full-res images themselves
  art.map(async (piece, i) =>
    <template id={ 'image-' + piece.id }>
      <Image
        class="max-h-screen object-contain w-auto h-auto"
        src={ piece.data.cover }
        alt={ piece.data.title }
        quality="max"
        width={piece.data.cover.width}
      />
    </template>
  )
}

<script type="text/javascript">
  (function() {
    'use strict';

    const viewer = document.getElementById('viewer');
    const imgContainer = document.getElementById('viewer__image');
    const mainArea = document.getElementById('viewer__main');
    const descContainer = document.getElementById('viewer__desc');
    const nextBtn = document.getElementById('viewer__next');
    const prevBtn = document.getElementById('viewer__prev');

    function init() {
      // turn thumbnails into image viewer activators
      document.querySelectorAll('.art-thumbnail').forEach(
        thumb => thumb.addEventListener('click', event => {
          event.preventDefault();
          showViewer(thumb.dataset.artId);
        })
      );

      // show viewer if there's an art ID specified in the URL
      const artId = new URLSearchParams(window.location.search).get('image');
      if (artId) showViewer(artId);

      document.getElementById('viewer__close').addEventListener('click', hideViewer);
      mainArea.addEventListener('click', e => { if (e.target === mainArea) hideViewer() });
    }

    function showViewer(artId) {
      viewer.classList.remove('hidden');
      document.querySelector('body').style.overflowY = "hidden";

      if (history.replaceState) {
        const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?image=' + artId;
        window.history.replaceState({path:newurl}, '', newurl);
      }

      const image = document.getElementById('image-' + artId).content.cloneNode(true);
      imgContainer.innerHTML = '';
      imgContainer.append(image);

      const desc = document.getElementById('desc-' + artId).content.cloneNode(true);
      descContainer.innerHTML = '';
      descContainer.append(desc);

      let artIndex = document.querySelector(`[data-art-id='${artId}']`).dataset.index;
      artIndex = Number(artIndex)
      const nextArt = document.querySelector(`[data-index='${artIndex + 1}']`)?.dataset?.artId;
      if (nextArt) {
        nextBtn.onclick = () => showViewer(nextArt);
        nextBtn.disabled = false;
      } else {
        nextBtn.disabled = true;
      }

      const prevArt = document.querySelector(`[data-index='${artIndex - 1}']`)?.dataset?.artId;
      if (prevArt) {
        prevBtn.onclick = () => showViewer(prevArt);
        prevBtn.disabled = false;
      } else {
        prevBtn.disabled = true;
      }
    }

    function hideViewer() {
      viewer.classList.add('hidden');
      document.querySelector('body').style.overflowY = "";

      if (history.replaceState) {
        const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname
        window.history.replaceState({path:newurl}, '', newurl);
      }
    }

    init();
  })();
</script>